"use client";

import { useEffect, useRef } from "react";
import gsap from "gsap";

interface OpeningProps {
  onComplete?: () => void;
}

export default function Opening({ onComplete }: OpeningProps) {
  const containerRef = useRef<HTMLDivElement>(null);
  const backgroundRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const letters = containerRef.current?.querySelectorAll(".letter");
    const background = backgroundRef.current;

    if (!letters || !background) return;

    // Opening中はカーソルを非表示にする
    document.body.style.cursor = "none";
    const cursorFollower = document.querySelector(
      ".follower"
    ) as HTMLDivElement | null;
    if (cursorFollower) {
      cursorFollower.style.opacity = "0";
      cursorFollower.style.visibility = "hidden";
    }

    // 最初は非表示
    gsap.set(letters, { opacity: 0, scale: 1, y: 20 });
    gsap.set(background, { opacity: 1 }); // 背景の初期状態を明示的に設定

    // 一文字ずつふわっと出現
    gsap.to(letters, {
      opacity: 1,
      ease: "sine.out",
      duration: 3, // アニメーション速度（全体の速さ）
      stagger: 0.3, // 各文字の遅延（調整ポイント）
      onComplete: () => {
        console.log("文字アニメーション完了、背景フェードアウト開始");
        // 文字アニメーション完了後、背景全体をふわっと消す
        gsap.to(background, {
          opacity: 0,
          duration: 1, // 3秒かけてゆっくり消す
          ease: "power2.out",
          delay: 1, // 2秒待ってから背景を消す
          onComplete: () => {
            console.log("背景フェードアウト完了");
            // カーソルを元に戻す
            document.body.style.cursor = "auto";
            const cursorFollower = document.querySelector(
              ".follower"
            ) as HTMLDivElement | null;
            if (cursorFollower) {
              cursorFollower.style.opacity = "";
              cursorFollower.style.visibility = "";
            }
            onComplete?.(); // 親コンポーネントに完了を通知
          },
        });
      },
    });

    // クリーンアップ関数
    return () => {
      document.body.style.cursor = "auto";
      const cursorFollower = document.querySelector(
        ".follower"
      ) as HTMLDivElement | null;
      if (cursorFollower) {
        cursorFollower.style.opacity = "";
        cursorFollower.style.visibility = "";
      }
    };
  }, [onComplete]);

  return (
    <div
      ref={backgroundRef}
      className="fixed inset-0 flex justify-center items-center w-full h-screen bg-bg z-9999 border-10 border-primary border-solid pointer-events-none"
    >
      <div ref={containerRef} className="flex items-end space-x-1">
        {/* B */}
        <div className="letter w-[100px]">
          <svg
            width="119"
            height="137"
            viewBox="0 0 119 137"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M0 137.001V135.631H5.48005C8.03741 135.631 10.0011 135.266 11.3711 134.535C12.7411 133.713 13.5175 132.252 13.7001 130.151V6.85006C13.5175 4.74937 12.7411 3.33369 11.3711 2.60302C10.0011 1.78101 8.03741 1.37 5.48005 1.37H0V0H54.1155H55.4855C63.0663 0 70.0533 1.87235 76.4467 5.61705C82.8401 9.36175 87.9092 14.4308 91.6539 20.8242C95.3986 27.2176 97.2709 34.2046 97.2709 41.7854C97.2709 44.4341 97.0882 46.8088 96.7229 48.9095C103.39 53.2022 108.688 58.9105 112.615 66.0346C116.542 73.0674 118.506 80.7394 118.506 89.0508C118.506 97.7276 116.36 105.765 112.067 113.163C107.774 120.47 101.929 126.27 94.5309 130.562C87.2242 134.855 79.2324 137.001 70.5557 137.001H0ZM55.4855 82.2008C60.6916 82.2008 65.5323 80.6481 70.0077 77.5427C74.5744 74.4374 78.3191 70.1903 81.2418 64.8016C84.2558 59.4129 86.0825 53.4762 86.7218 46.9914C81.5158 43.9774 76.1271 42.4704 70.5557 42.4704H68.5006C64.6646 42.4704 61.6506 43.6577 59.4586 46.0324C57.2665 48.4071 56.1705 51.7865 56.1705 56.1705V63.7056C56.1705 64.1623 55.9422 64.3906 55.4855 64.3906C55.0289 64.3906 54.8005 64.1623 54.8005 63.7056V56.1705C54.8005 51.7865 53.7045 48.4071 51.5125 46.0324C49.3205 43.6577 46.3064 42.4704 42.4704 42.4704H33.5653C33.1086 42.4704 32.8803 42.2421 32.8803 41.7854C32.8803 41.3287 33.1086 41.1004 33.5653 41.1004H42.4704C46.3064 41.1004 49.3205 39.913 51.5125 37.5383C53.7045 35.1637 54.8005 31.7843 54.8005 27.4003V19.8652C54.8005 19.4085 55.0289 19.1802 55.4855 19.1802C55.9422 19.1802 56.1705 19.4085 56.1705 19.8652V27.4003C56.1705 31.7843 57.2665 35.1637 59.4586 37.5383C61.6506 39.913 64.6646 41.1004 68.5006 41.1004H70.5557C76.3097 41.1004 81.7898 42.0594 86.9958 43.9774V41.7854C86.9958 34.4787 85.5801 27.7656 82.7488 21.6462C79.9174 15.4355 76.0814 10.5034 71.2407 6.85006C66.4 3.19669 61.1482 1.37 55.4855 1.37C48.1788 1.37 41.4201 3.19669 35.2093 6.85006C29.0899 10.5034 24.2036 15.4355 20.5502 21.6462C16.8968 27.7656 15.0701 34.4787 15.0701 41.7854C15.0701 49.0921 16.8968 55.8509 20.5502 62.0616C24.2036 68.181 29.0899 73.0674 35.2093 76.7207C41.4201 80.3741 48.1788 82.2008 55.4855 82.2008ZM55.4855 83.5708C49.2748 83.5708 43.4294 82.2921 37.9494 79.7347C32.5606 77.1774 27.9026 73.661 23.9752 69.1856V89.0508C23.9752 97.4536 26.0759 105.217 30.2773 112.341C34.4787 119.465 40.1414 125.128 47.2654 129.329C54.3895 133.531 62.1529 135.631 70.5557 135.631C77.3144 135.631 83.5708 133.531 89.3248 129.329C95.1702 125.128 99.7826 119.465 103.162 112.341C106.541 105.217 108.231 97.4536 108.231 89.0508C108.231 82.2008 107.089 75.7617 104.806 69.7337C102.523 63.7056 99.3716 58.4995 95.3529 54.1155C93.6175 59.7782 90.7862 64.8473 86.8588 69.3226C82.9314 73.798 78.2277 77.3144 72.7477 79.8717C67.359 82.3378 61.6049 83.5708 55.4855 83.5708ZM23.9752 130.151C24.1579 132.252 24.9342 133.713 26.3042 134.535C27.6743 135.266 29.6379 135.631 32.1953 135.631H59.1846C50.5991 133.531 43.1097 129.284 36.7163 122.89C30.323 116.497 26.0759 109.007 23.9752 100.422V130.151ZM23.9752 14.3851C29.7293 7.9004 36.7163 3.56203 44.9364 1.37H32.1953C29.6379 1.37 27.6743 1.78101 26.3042 2.60302C24.9342 3.33369 24.1579 4.74937 23.9752 6.85006V14.3851Z"
              fill="var(--color-primary)"
            />
          </svg>
        </div>

        {/* L */}
        <div className="letter w-[120px]">
          <svg
            width="123"
            height="137"
            viewBox="0 0 123 137"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M0 135.631H7.91808C11.6132 135.631 14.4505 135.266 16.43 134.535C18.4095 133.713 19.5313 132.252 19.7952 130.151V6.85006C19.5313 4.74937 18.4095 3.33369 16.43 2.60302C14.4505 1.78101 11.6132 1.37 7.91808 1.37H0V0H54.4368V1.37H46.5187C42.8236 1.37 39.9863 1.78101 38.0068 2.60302C36.0273 3.33369 34.9055 4.74937 34.6416 6.85006V130.151C34.9055 132.252 36.0273 133.713 38.0068 134.535C39.9863 135.266 42.8236 135.631 46.5187 135.631H89.0785C100.956 134.901 109.204 131.795 113.822 126.315C118.441 120.744 120.751 112.889 120.751 102.751H122.73V137.001H0V135.631Z"
              fill="var(--color-primary)"
            />
          </svg>
        </div>

        {/* O（増殖する部分） */}
        {[...Array(5)].map((_, i) => (
          <div key={i} className="letter w-[79px]">
            <svg
              width="84"
              height="84"
              viewBox="0 0 84 84"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M41.7854 0C49.3661 0 56.3532 1.87235 62.7466 5.61705C69.14 9.36176 74.209 14.4308 77.9537 20.8242C81.6984 27.2176 83.5708 34.2047 83.5708 41.7854C83.5708 48.9095 81.6528 55.7139 77.8167 62.1986C74.072 68.592 69.003 73.7524 62.6096 77.6797C56.2162 81.6071 49.2748 83.5708 41.7854 83.5708C34.2047 83.5708 27.2176 81.6984 20.8242 77.9537C14.4308 74.209 9.36175 69.14 5.61705 62.7466C1.87235 56.3532 0 49.3661 0 41.7854C0 34.2047 1.87235 27.2176 5.61705 20.8242C9.36175 14.4308 14.4308 9.36176 20.8242 5.61705C27.2176 1.87235 34.2047 0 41.7854 0ZM41.7854 1.37001C36.1227 1.37001 30.871 3.1967 26.0302 6.85007C21.1895 10.5034 17.3535 15.4355 14.5221 21.6462C11.6908 27.7656 10.2751 34.4787 10.2751 41.7854C10.2751 49.0921 11.6908 55.8509 14.5221 62.0616C17.3535 68.181 21.1895 73.0674 26.0302 76.7207C30.871 80.3741 36.1227 82.2008 41.7854 82.2008C47.3568 82.2008 52.5628 80.3284 57.4035 76.5837C62.2443 72.7477 66.0803 67.7243 68.9116 61.5136C71.8343 55.3029 73.2957 48.7268 73.2957 41.7854C73.2957 34.4787 71.88 27.7656 69.0486 21.6462C66.2173 15.4355 62.3812 10.5034 57.5405 6.85007C52.6998 3.1967 47.4481 1.37001 41.7854 1.37001Z"
                fill="var(--color-primary)"
              />
            </svg>
          </div>
        ))}

        {/* G */}
        <div className="letter w-[150px]">
          <svg
            width="151"
            height="137"
            viewBox="0 0 151 137"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M137.001 130.151C137.184 132.252 137.96 133.713 139.33 134.535C140.7 135.266 142.664 135.631 145.221 135.631H150.701V137.001H68.5006C56.0792 137.001 44.6167 133.942 34.1133 127.822C23.6099 121.703 15.2985 113.391 9.17909 102.888C3.0597 92.3845 0 80.9221 0 68.5006C0 56.0792 3.0597 44.6167 9.17909 34.1133C15.2985 23.6099 23.6099 15.2985 34.1133 9.17908C44.6167 3.05969 56.0792 0 68.5006 0C78.9127 0 88.6855 2.10068 97.8189 6.30205C107.044 10.4121 114.716 15.9835 120.835 23.0162C126.954 30.0489 130.882 37.6753 132.617 45.8954H131.247C129.421 38.3147 125.539 31.0993 119.602 24.2492C113.665 17.3992 106.222 11.8734 97.2709 7.67206C88.4115 3.47069 78.8214 1.37 68.5006 1.37C57.9059 1.37 48.1331 4.38403 39.1824 10.4121C30.3229 16.4401 23.2902 24.6146 18.0842 34.9353C12.8781 45.1648 10.2751 56.3532 10.2751 68.5006C10.2751 80.6481 12.8781 91.8822 18.0842 102.203C23.2902 112.432 30.3229 120.561 39.1824 126.589C48.1331 132.617 57.9059 135.631 68.5006 135.631C79.0041 135.631 88.6855 132.663 97.5449 126.726C106.404 120.789 113.437 112.752 118.643 102.614C123.94 92.3845 126.635 81.2418 126.726 69.1856H93.1609C88.7768 69.1856 84.7581 70.3273 81.1048 72.6107C77.4514 74.894 74.5287 78.1364 72.3366 82.3378C70.236 86.4478 69.1857 91.1972 69.1857 96.5859V117.136C69.1857 117.319 69.0943 117.501 68.9116 117.684C68.8203 117.775 68.6833 117.821 68.5006 117.821C68.318 117.821 68.1353 117.775 67.9526 117.684C67.8613 117.501 67.8156 117.319 67.8156 117.136V96.5859C67.8156 91.1972 66.7196 86.4478 64.5276 82.3378C62.4269 78.1364 59.5499 74.894 55.8965 72.6107C52.2431 70.3273 48.2244 69.1856 43.8404 69.1856H19.8652C19.4085 69.1856 19.1802 68.9573 19.1802 68.5006C19.1802 68.044 19.4085 67.8156 19.8652 67.8156H43.8404C48.2244 67.8156 52.2431 66.674 55.8965 64.3906C59.5499 62.1072 62.4269 58.9105 64.5276 54.8005C66.7196 50.5991 67.8156 45.8041 67.8156 40.4154V19.8652C67.8156 19.4085 68.044 19.1802 68.5006 19.1802C68.9573 19.1802 69.1857 19.4085 69.1857 19.8652V40.4154C69.1857 45.8041 70.236 50.5991 72.3366 54.8005C74.5287 58.9105 77.4514 62.1072 81.1048 64.3906C84.7581 66.674 88.7768 67.8156 93.1609 67.8156H137.001V130.151ZM115.766 135.631C119.145 135.631 121.748 135.266 123.575 134.535C125.402 133.713 126.452 132.252 126.726 130.151V104.669C121.794 112.615 115.446 119.282 107.683 124.671C100.011 130.06 91.5169 133.713 82.2008 135.631H115.766Z"
              fill="var(--color-primary)"
            />
          </svg>
        </div>
      </div>
    </div>
  );
}
